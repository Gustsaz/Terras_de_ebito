// adm.js - Admin panel to list users and their characters

document.addEventListener("DOMContentLoaded", async () => {
    console.log('Loading adm.js');

    // Check if admin is logged in (password check, but since we came from modal with password, assume ok)
    // Load all users from 'usuarios' collection

    const usersList = document.getElementById('users-list');
    const charactersSection = document.getElementById('characters-section');
    const charactersList = document.getElementById('characters-list');
    const userNameSpan = document.getElementById('user-name');

    let currentUserId = null;

    // Function to load all users
    async function loadUsers() {
        try {
            const usuariosCol = window.collection(window.firestoredb, 'usuarios');
            const snapshot = await window.getDocs(usuariosCol);
            usersList.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const name = data.name || 'Nome não definido';
                const email = data.email || 'Email não definido';
                const uid = doc.id;

                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info">
                        <h3>${name}</h3>
                        <p>Email: ${email}</p>
                        <p>UID: ${uid}</p>
                    </div>
                `;
                userItem.addEventListener('click', () => {
                    document.querySelectorAll('.user-item').forEach(it => it.classList.remove('active'));
                    userItem.classList.add('active');
                    loadUserCharacters(uid, name);
                });
                usersList.appendChild(userItem);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            usersList.innerHTML = '<p>Erro ao carregar usuários.</p>';
        }
    }

    // Function to load characters of a user
    async function loadUserCharacters(uid, name) {
        currentUserId = uid;
        userNameSpan.textContent = name;
        charactersSection.style.display = 'block';

        // Hide other user active
        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
        const items = usersList.querySelectorAll('.user-item');
        // Find the item with uid
        // Since we don't have uid in the item, perhaps set active based on clicked

        try {
            const docRef = window.doc(window.firestoredb, 'usuarios', uid);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) {
                charactersList.innerHTML = '<p>Usuário não encontrado.</p>';
                return;
            }
            const data = docSnap.data();
            const characters = data.personagens || [];
            charactersList.innerHTML = '';

            if (characters.length === 0) {
                charactersList.innerHTML = '<p>Nenhum personagem criado.</p>';
                return;
            }

            characters.forEach(char => {
                const imgSrc = (char.img && Array.isArray(char.img) && char.img.length > 0)
                    ? char.img[0]
                    : `./imgs/${char.classe.toLowerCase()}.png`;

                const charId = char.uid;
                const charCard = document.createElement('div');
                charCard.className = 'character-card';
                charCard.innerHTML = `
                    <img src="${imgSrc}" alt="Character ${char.nome}" onerror="this.src='./imgs/placeholder.png'">
                    <h4>${char.nome}</h4>
                    <p>Classe: ${char.classe}</p>
                    <p>Raça: ${char.raca}${char.subraca ? ` (${char.subraca})` : ''}</p>
                    <p>Nível: ${char.LVL}</p>
                `;
                charCard.addEventListener('click', () => {
                    window.location.href = 'personagemadm.html?uid=' + encodeURIComponent(charId);
                });
                charactersList.appendChild(charCard);
            });
        } catch (error) {
            console.error('Error loading characters:', error);
            charactersList.innerHTML = '<p>Erro ao carregar personagens.</p>';
        }
    }

    // Load users on load
    await loadUsers();

    // Add back button
    const backBtn = document.createElement('button');
    backBtn.className = 'back-to-users';
    backBtn.textContent = 'Voltar para Usuários';
    backBtn.addEventListener('click', () => {
        charactersSection.style.display = 'none';
        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
    });

    charactersSection.querySelector('h2').appendChild(backBtn);
});

/* helper: resolve firestore functions (uses window.* if available; otherwise dynamic import) */
async function resolveFirestoreFunctions() {
    // cache module on window to avoid multiple imports
    if (window.__FS_MODULE__) {
        const m = window.__FS_MODULE__;
        return {
            collection: m.collection || window.collection,
            getDocs: m.getDocs || window.getDocs,
            addDoc: m.addDoc || window.addDoc,
            doc: m.doc || window.doc,
            getDoc: m.getDoc || window.getDoc,
            setDoc: m.setDoc || window.setDoc,
            updateDoc: m.updateDoc || window.updateDoc,
            deleteDoc: m.deleteDoc || window.deleteDoc
        };
    }

    // prefer using existing window exports if they are functions
    const haveWindowFns = (typeof window.collection === 'function') && (typeof window.getDocs === 'function');

    if (haveWindowFns) {
        return {
            collection: window.collection,
            getDocs: window.getDocs,
            addDoc: window.addDoc,
            doc: window.doc,
            getDoc: window.getDoc,
            setDoc: window.setDoc,
            updateDoc: window.updateDoc,
            deleteDoc: window.deleteDoc
        };
    }

    // fallback: dynamic import from firebase CDN
    try {
        const mod = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js');
        window.__FS_MODULE__ = mod;
        return {
            collection: mod.collection,
            getDocs: mod.getDocs,
            addDoc: mod.addDoc,
            doc: mod.doc,
            getDoc: mod.getDoc,
            setDoc: mod.setDoc,
            updateDoc: mod.updateDoc,
            deleteDoc: mod.deleteDoc
        };
    } catch (err) {
        console.warn('resolveFirestoreFunctions: import failed, falling back to window.* (may error):', err);
        return {
            collection: window.collection,
            getDocs: window.getDocs,
            addDoc: window.addDoc,
            doc: window.doc,
            getDoc: window.getDoc,
            setDoc: window.setDoc,
            updateDoc: window.updateDoc,
            deleteDoc: window.deleteDoc
        };
    }
}

// --- helpers seguros para Firestore (cole após resolveFirestoreFunctions) ---
async function getCollectionRefSafe(collectionName) {
    const fns = await resolveFirestoreFunctions();
    // espera/valida que o db exista
    if (!window.firestoredb) {
        // espera curto para garantir inicialização (se não inicializou, lança)
        await new Promise(r => setTimeout(r, 200));
        if (!window.firestoredb) throw new Error('Firestore não disponível (window.firestoredb indefinido).');
    }
    const collectionFn = (typeof fns.collection === 'function') ? fns.collection : (typeof window.collection === 'function' ? window.collection : null);
    if (!collectionFn) throw new Error('Função collection não encontrada (fns.collection / window.collection).');
    return collectionFn(window.firestoredb, collectionName);
}

// --- helper: aguarda Firestore + funções de firestore ficarem disponíveis ---
async function waitForFirestoreReady(timeout = 5000, interval = 120) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
        try {
            // tenta resolver as funções (importará se precisar)
            const fns = await resolveFirestoreFunctions();
            const haveCollectionFn = (typeof fns.collection === 'function') || (typeof window.collection === 'function');
            if (haveCollectionFn && window.firestoredb) {
                return; // pronto
            }
        } catch (err) {
            // ignora e tenta novamente
        }
        await new Promise(r => setTimeout(r, interval));
    }
    throw new Error('waitForFirestoreReady: Firestore não ficou pronto no tempo esperado.');
}

async function getDocRefSafe(collectionName, docId) {
    const fns = await resolveFirestoreFunctions();
    if (!window.firestoredb) {
        await new Promise(r => setTimeout(r, 200));
        if (!window.firestoredb) throw new Error('Firestore não disponível (window.firestoredb indefinido).');
    }
    const docFn = (typeof fns.doc === 'function') ? fns.doc : (typeof window.doc === 'function' ? window.doc : null);
    if (!docFn) throw new Error('Função doc não encontrada (fns.doc / window.doc).');
    return docFn(window.firestoredb, collectionName, docId);
}


/* === CAMINHOS: list / edit / create com niveis fixos === */
(function () {
    const CAMINHOS_COLLECTION = 'caminhos'; // <- nome da coleção conforme você descreveu
    const TARGET_NIVEIS = 7; // quantidade exata de índices desejada (mude aqui se quiser outro valor)

    const openBtn = document.getElementById('open-add-caminho');
    const panel = document.getElementById('add-caminho-panel');
    const closeBtn = panel?.querySelector('.close-add-caminho');
    const form = document.getElementById('add-caminho-form');
    const niveisContainer = document.getElementById('niveis-container');
    const addNivelBtn = document.getElementById('add-nivel-btn');
    const cancelBtn = document.getElementById('cancel-add-caminho');
    const loadExampleBtn = document.getElementById('load-example-btn');

    const caminhosListEl = document.getElementById('caminhos-list');
    const novoCaminhoBtn = document.getElementById('novo-caminho-btn');
    const refreshCaminhosBtn = document.getElementById('refresh-caminhos-btn');

    if (!form) return;

    function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    function createNivelItem(nome = '', descricao = '') {
        const wrapper = document.createElement('div');
        wrapper.className = 'nivel-item';
        wrapper.innerHTML = `
      <div class="nivel-row">
        <div style="flex:1;">
          <label>Nome do Nível
            <input type="text" class="nivel-nome" value="${escapeHtml(nome)}" required />
          </label>
        </div>
        <button type="button" class="remove-nivel" title="Remover Nível">✕</button>
      </div>
      <label>Descrição do Nível
        <textarea class="nivel-desc" rows="3" required>${escapeHtml(descricao)}</textarea>
      </label>
    `;
        wrapper.querySelector('.remove-nivel').addEventListener('click', () => wrapper.remove());
        return wrapper;
    }

    // --- normalize niveis: garante EXACTAMENTE targetLength entradas ---
    function normalizeNiveis(inputArray, targetLength = TARGET_NIVEIS) {
        const out = [];
        // map/transform elementos válidos
        (Array.isArray(inputArray) ? inputArray : []).forEach(item => {
            if (!item) return;
            const nome = (item.nome || item.nome === '') ? item.nome : (item.nome || '');
            const descricao = item.descricao_nivel || item.descricao || '';
            out.push({ nome: String(nome), descricao_nivel: String(descricao) });
        });
        // se faltar, preenche com objetos vazios
        while (out.length < targetLength) out.push({ nome: '', descricao_nivel: '' });
        // se tiver a mais, corta
        if (out.length > targetLength) out.length = targetLength;
        return out;
    }

    // --- abrir painel modo novo ---
    function openFormForNew() {
        form.removeAttribute('data-doc-id');
        form.reset();
        niveisContainer.innerHTML = '';
        // preenche com o número exato de niveis vazios
        for (let i = 0; i < TARGET_NIVEIS; i++) niveisContainer.appendChild(createNivelItem('', ''));
        panel.style.display = 'block';
    }

    // --- abrir painel modo editar: carrega doc do firestore ---
    async function openFormForEdit(docId) {
        try {
            const fns = await resolveFirestoreFunctions();
            const docRef = fns.doc(window.firestoredb, CAMINHOS_COLLECTION, docId);
            const docSnap = await fns.getDoc(docRef);
            if (!docSnap.exists()) { alert('Documento não encontrado.'); return; }
            const data = docSnap.data();

            // preencher campos principais
            document.getElementById('c_classe').value = data.classe || '';
            document.getElementById('c_nome').value = data.nome || '';
            document.getElementById('c_descricao_geral').value = data.descricao_geral || '';
            document.getElementById('c_img').value = data.img || '';

            // preencher niveis normalizados (garantir EXACTAMENTE TARGET_NIVEIS)
            const normalized = normalizeNiveis(data.niveis || []);
            niveisContainer.innerHTML = '';
            normalized.forEach(n => niveisContainer.appendChild(createNivelItem(n.nome, n.descricao_nivel)));

            // marcar doc id no form (usado no submit)
            form.setAttribute('data-doc-id', docId);
            panel.style.display = 'block';
        } catch (err) {
            console.error('Erro ao carregar documento para edição:', err);
            alert('Erro ao carregar dados do documento (veja console).');
        }
    }

    // --- render lista de caminhos ---
    async function loadCaminhos() {
        try {
            caminhosListEl.innerHTML = '<p>Carregando...</p>';
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, CAMINHOS_COLLECTION);
            const snap = await fns.getDocs(colRef);
            caminhosListEl.innerHTML = '';

            if (!snap || snap.size === 0) {
                caminhosListEl.innerHTML = '<p>Nenhum caminho cadastrado.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'caminho-card';
                card.innerHTML = `
          <h4>${data.nome || 'Sem nome'}</h4>
          <p><strong>Classe:</strong> ${data.classe || '-'}</p>
          <p>${(data.descricao_geral || '').slice(0, 120)}${(data.descricao_geral && data.descricao_geral.length > 120) ? '...' : ''}</p>
          <div class="card-actions">
            <button data-edit-id="${id}" class="edit-caminho-btn">Editar</button>
            <button data-delete-id="${id}" class="del-caminho-btn">Excluir</button>
          </div>
        `;
                caminhosListEl.appendChild(card);
            });

            // delegação de eventos (editar/excluir)
            caminhosListEl.querySelectorAll('.edit-caminho-btn').forEach(btn => {
                btn.addEventListener('click', () => openFormForEdit(btn.dataset.editId));
            });
            caminhosListEl.querySelectorAll('.del-caminho-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.deleteId;
                    if (!confirm('Confirma excluir este caminho?')) return;
                    try {
                        const fns = await resolveFirestoreFunctions();
                        const docRef = fns.doc(window.firestoredb, CAMINHOS_COLLECTION, id);
                        if (typeof fns.deleteDoc === 'function') {
                            await fns.deleteDoc(docRef);
                        } else if (typeof window.deleteDoc === 'function') {
                            await window.deleteDoc(docRef);
                        } else if (typeof fns.setDoc === 'function') {
                            await fns.setDoc(docRef, { _deleted: true }, { merge: true });
                        }
                        alert('Excluído.');
                        //loadCaminhos();
                        refreshFeiticoHistoryCache(); // atualizar cache (pode ser sem await)

                    } catch (err) {
                        console.error('Erro excluindo:', err);
                        alert('Erro ao excluir (veja console).');
                    }
                });
            });

        } catch (err) {
            console.error('Erro ao carregar caminhos:', err);
            caminhosListEl.innerHTML = '<p>Erro ao carregar caminhos.</p>';
        }
    }

    // --- inicializações e eventos ---
    novoCaminhoBtn?.addEventListener('click', openFormForNew);
    refreshCaminhosBtn?.addEventListener('click', loadCaminhos);

    openBtn?.addEventListener('click', openFormForNew); // botão existente também abre novo
    closeBtn?.addEventListener('click', () => panel.style.display = 'none');
    cancelBtn?.addEventListener('click', () => panel.style.display = 'none');

    addNivelBtn?.addEventListener('click', () => niveisContainer.appendChild(createNivelItem('', '')));

    loadExampleBtn?.addEventListener('click', () => {
        // exemplo: preenche (você pode ajustar esse array de exemplo)
        document.getElementById('c_classe').value = 'Arcanista';
        document.getElementById('c_nome').value = 'Conjurador Elemental';
        document.getElementById('c_descricao_geral').value = 'O Conjurador Elemental domina os quatro pilares do mundo físico Fogo, Água, Ar e Terra e os canaliza como extensão do próprio corpo. É o poder bruto da natureza moldado pela mente.';
        document.getElementById('c_img').value = './imgs/Conjurador_elemental.png';

        const niveisEx = [
            { nome: 'Fonte elementar', descricao: '...' },
            { nome: 'Fonte elementar I', descricao: '...' },
            { nome: 'Fonte elementar II', descricao: '...' },
            { nome: 'Fonte elementar III', descricao: '...' },
            { nome: 'Fonte elementar IV', descricao: '...' },
            { nome: 'Fonte elementar V', descricao: '...' }
        ];
        niveisContainer.innerHTML = '';
        niveisEx.forEach(n => niveisContainer.appendChild(createNivelItem(n.nome, n.descricao)));
    });

    // --- form submit: cria ou atualiza documento garantindo niveis com TARGET_NIVEIS ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const classe = document.getElementById('c_classe').value.trim();
            const nome = document.getElementById('c_nome').value.trim();
            const descricao_geral = document.getElementById('c_descricao_geral').value.trim();
            const img = document.getElementById('c_img').value.trim() || './imgs/placeholder.png';

            // montar array niveis a partir do DOM
            const niveisNodes = Array.from(niveisContainer.querySelectorAll('.nivel-item'));
            const niveisRaw = niveisNodes.map(node => {
                return {
                    nome: (node.querySelector('.nivel-nome').value || '').trim(),
                    descricao_nivel: (node.querySelector('.nivel-desc').value || '').trim()
                };
            });

            // normaliza p/ TARGET_NIVEIS
            const niveis = normalizeNiveis(niveisRaw, TARGET_NIVEIS);

            // validações mínimas
            if (!classe || !nome || !descricao_geral) {
                alert('Preencha: classe, nome e descrição geral.');
                return;
            }

            const payload = { classe, nome, descricao_geral, img, niveis };

            const docId = form.getAttribute('data-doc-id');
            const fns = await resolveFirestoreFunctions();
            if (docId) {
                // atualizar documento existente
                const docRef = fns.doc(window.firestoredb, CAMINHOS_COLLECTION, docId);
                try {
                    if (typeof fns.setDoc === 'function') {
                        await fns.setDoc(docRef, payload, { merge: true });
                    } else if (typeof fns.updateDoc === 'function') {
                        await fns.updateDoc(docRef, payload);
                    } else {
                        console.warn('Nenhuma função setDoc/updateDoc disponível, usando addDoc fallback.');
                        await fns.addDoc(fns.collection(window.firestoredb, CAMINHOS_COLLECTION), payload);
                    }
                    alert('Caminho atualizado com sucesso.');
                } catch (err) {
                    console.error('Erro ao atualizar doc:', err);
                    alert('Erro ao atualizar (veja console).');
                }
            } else {
                // criar novo documento
                try {
                    await fns.addDoc(fns.collection(window.firestoredb, CAMINHOS_COLLECTION), payload);
                    alert('Caminho criado com sucesso.');
                } catch (err) {
                    console.error('Erro ao criar caminho:', err);
                    alert('Erro ao criar caminho (veja console).');
                }
            }

            // limpar UI
            form.reset();
            niveisContainer.innerHTML = '';
            for (let i = 0; i < TARGET_NIVEIS; i++) niveisContainer.appendChild(createNivelItem('', ''));
            panel.style.display = 'none';
            // recarregar lista
            //loadCaminhos();
        } catch (err) {
            console.error('Erro no submit do caminho:', err);
            alert('Erro inesperado (veja console).');
        }
    });

    // carrega lista inicialmente
    //loadCaminhos();
})();

/* === CONDIÇÕES: list / edit / create === */
(function () {
    const CONDICOES_COLLECTION = 'condicoes';

    const openBtn = document.getElementById('open-add-condicao');
    const panel = document.getElementById('add-condicao-panel');
    const closeBtn = panel?.querySelector('.close-add-condicao');
    const form = document.getElementById('add-condicao-form');

    const condicoesListEl = document.getElementById('condicoes-list');
    const novoCondBtn = document.getElementById('novo-condicao-btn');
    const refreshCondBtn = document.getElementById('refresh-condicoes-btn');
    const cancelBtn = document.getElementById('cancel-add-condicao');

    if (!form) return;

    // --- color picker sync (local à UI de Condições) ---
    const colorInput = document.getElementById('cond_cor');
    const colorHexInput = document.getElementById('cond_cor_hex');

    if (colorInput) {
        colorInput.addEventListener('input', () => {
            if (colorHexInput) colorHexInput.value = colorInput.value.toUpperCase();
        });
        if (colorHexInput && colorInput.value) colorHexInput.value = colorInput.value.toUpperCase();
    }

    // helpers
    function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    async function loadCondicoes() {
        try {
            condicoesListEl.innerHTML = '<p>Carregando...</p>';
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, CONDICOES_COLLECTION);
            const snap = await fns.getDocs(colRef);
            condicoesListEl.innerHTML = '';

            if (!snap || snap.size === 0) {
                condicoesListEl.innerHTML = '<p>Nenhuma condição cadastrada.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'condicao-card';
                const badgeStyle = data.cor ? `style="background:${escapeHtml(data.cor)}"` : '';
                card.innerHTML = `
          <h4>${escapeHtml(data.nome || 'Sem nome')}</h4>
          <p><span class="cond-badge" ${badgeStyle}>${escapeHtml(data.tipo || '')}</span></p>
          <p>${escapeHtml((data.descricao || '').slice(0, 120))}${(data.descricao && data.descricao.length > 120) ? '...' : ''}</p>
          <p><strong>Duração:</strong> ${escapeHtml(data.duracao || '')}</p>
          <p><strong>Efeito:</strong> ${escapeHtml(data.efeito || '')}</p>
          <div class="card-actions">
            <button data-edit-id="${id}" class="edit-cond-btn">Editar</button>
            <button data-delete-id="${id}" class="del-cond-btn">Excluir</button>
          </div>
        `;
                condicoesListEl.appendChild(card);
            });

            condicoesListEl.querySelectorAll('.edit-cond-btn').forEach(btn => {
                btn.addEventListener('click', () => openFormForEdit(btn.dataset.editId));
            });
            condicoesListEl.querySelectorAll('.del-cond-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.deleteId;
                    if (!confirm('Confirma excluir esta condição?')) return;
                    try {
                        const fns = await resolveFirestoreFunctions();
                        const docRef = fns.doc(window.firestoredb, CONDICOES_COLLECTION, id);
                        if (typeof fns.deleteDoc === 'function') await fns.deleteDoc(docRef);
                        else if (typeof window.deleteDoc === 'function') await window.deleteDoc(docRef);
                        else await fns.setDoc(docRef, { _deleted: true }, { merge: true });
                        alert('Excluído.');
                        //loadCondicoes();
                    } catch (err) {
                        console.error('Erro excluindo condicao:', err);
                        alert('Erro ao excluir (veja console).');
                    }
                });
            });

        } catch (err) {
            console.error('Erro ao carregar condicoes:', err);
            condicoesListEl.innerHTML = '<p>Erro ao carregar condições.</p>';
        }
    }

    function openFormForNew() {
        form.removeAttribute('data-doc-id');
        form.reset();
        // valores exemplo (pode remover)
        if (typeof colorInput !== 'undefined' && colorInput) colorInput.value = '#696565';
        if (typeof colorHexInput !== 'undefined' && colorHexInput) colorHexInput.value = '#696565';

        document.getElementById('cond_tipo').value = 'positiva';
        document.getElementById('cond_duracao').value = '1d4 turnos.';
        document.getElementById('cond_efeito').value = '+1 a +3 Defesa ou -25% a -50% de dano recebido.';
        document.getElementById('cond_descricao').value = 'Energia mágica protege o corpo.';
        panel.style.display = 'block';
    }

    async function openFormForEdit(docId) {
        try {
            const fns = await resolveFirestoreFunctions();
            const docRef = fns.doc(window.firestoredb, CONDICOES_COLLECTION, docId);
            const snap = await fns.getDoc(docRef);
            if (!snap.exists()) { alert('Documento não encontrado.'); return; }
            const data = snap.data();
            document.getElementById('cond_nome').value = data.nome || '';
            document.getElementById('cond_tipo').value = data.tipo || '';
            if (colorInput) colorInput.value = (data.cor && data.cor !== '') ? data.cor : '#696565';
            if (colorHexInput) colorHexInput.value = (data.cor && data.cor !== '') ? data.cor : '#696565';
            document.getElementById('cond_duracao').value = data.duracao || '';
            document.getElementById('cond_efeito').value = data.efeito || '';
            document.getElementById('cond_descricao').value = data.descricao || '';
            form.setAttribute('data-doc-id', docId);
            panel.style.display = 'block';
        } catch (err) {
            console.error('Erro ao abrir condicao para editar:', err);
            alert('Erro ao carregar condição.');
        }
    }

    // eventos
    novoCondBtn?.addEventListener('click', openFormForNew);
    refreshCondBtn?.addEventListener('click', loadCondicoes);
    openBtn?.addEventListener('click', openFormForNew);
    closeBtn?.addEventListener('click', () => panel.style.display = 'none');
    cancelBtn?.addEventListener('click', () => panel.style.display = 'none');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const nome = document.getElementById('cond_nome').value.trim();
            const tipo = document.getElementById('cond_tipo').value.trim();
            const cor = document.getElementById('cond_cor').value.trim();
            const duracao = document.getElementById('cond_duracao').value.trim();
            const efeito = document.getElementById('cond_efeito').value.trim();
            const descricao = document.getElementById('cond_descricao').value.trim();

            if (!nome) { alert('Preencha ao menos o nome.'); return; }

            const payload = { nome, tipo, cor, duracao, efeito, descricao };

            const docId = form.getAttribute('data-doc-id');
            const fns = await resolveFirestoreFunctions();
            if (docId) {
                const docRef = fns.doc(window.firestoredb, CONDICOES_COLLECTION, docId);
                if (typeof fns.setDoc === 'function') await fns.setDoc(docRef, payload, { merge: true });
                else if (typeof fns.updateDoc === 'function') await fns.updateDoc(docRef, payload);
                else await fns.addDoc(fns.collection(window.firestoredb, CONDICOES_COLLECTION), payload);
                alert('Condição atualizada.');
            } else {
                await fns.addDoc(fns.collection(window.firestoredb, CONDICOES_COLLECTION), payload);
                alert('Condição criada.');
            }

            form.reset();
            panel.style.display = 'none';
            //loadCondicoes();
        } catch (err) {
            console.error('Erro ao salvar condicao:', err);
            alert('Erro ao salvar condição (veja console).');
        }
    });

    // inicial
    //loadCondicoes();
})();

/* === ITENS: list / edit / create / delete + Histórico por campo === */
(function () {
    const ITENS_COLLECTION = 'itens';

    const openBtn = document.getElementById('open-add-item');
    const panel = document.getElementById('add-item-panel');
    const closeBtn = panel?.querySelector('.close-add-item');
    const form = document.getElementById('add-item-form');

    const itensListEl = document.getElementById('itens-list');
    const novoItemBtn = document.getElementById('novo-item-btn');
    const refreshItensBtn = document.getElementById('refresh-itens-btn');
    const cancelBtn = document.getElementById('cancel-add-item');

    if (!form) return;

    /* ===== Histórico inline para campos categoria / tipo_item / tipo_dano ===== */
    const _historyCache = {}; // cache por campo

    async function fetchHistoryValues(field) {
        if (_historyCache[field]) return _historyCache[field];
        try {
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, ITENS_COLLECTION);
            const snap = await fns.getDocs(colRef);
            const set = new Set();
            snap.forEach(doc => {
                const val = doc.data()[field];
                if (val !== undefined && val !== null) {
                    const s = String(val).trim();
                    if (s) set.add(s);
                }
            });
            const arr = Array.from(set).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
            _historyCache[field] = arr;
            return arr;
        } catch (err) {
            console.error('fetchHistoryValues error', err);
            return [];
        }
    }

    function buildHistoryDropdown(field, targetDropdown, items) {
        targetDropdown.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'history-item';
            empty.textContent = 'Nenhum histórico';
            targetDropdown.appendChild(empty);
        } else {
            items.forEach(val => {
                const it = document.createElement('div');
                it.className = 'history-item';
                it.tabIndex = 0;
                it.textContent = val;
                it.addEventListener('click', () => {
                    const input = document.getElementById('item_' + field);
                    if (input) input.value = val;
                    hideAllDropdowns();
                    input.focus();
                });
                it.addEventListener('keydown', (e) => { if (e.key === 'Enter') it.click(); });
                targetDropdown.appendChild(it);
            });
        }

        const footer = document.createElement('div');
        footer.className = 'history-footer';
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.textContent = 'Limpar';
        clearBtn.addEventListener('click', () => {
            const input = document.getElementById('item_' + field);
            if (input) input.value = '';
            hideAllDropdowns();
            input.focus();
        });
        const closeBtnF = document.createElement('button');
        closeBtnF.type = 'button';
        closeBtnF.textContent = 'Fechar';
        closeBtnF.addEventListener('click', hideAllDropdowns);
        footer.appendChild(clearBtn);
        footer.appendChild(closeBtnF);
        targetDropdown.appendChild(footer);
    }

    function hideAllDropdowns() {
        panel.querySelectorAll('.history-dropdown').forEach(d => d.setAttribute('hidden', ''));
    }

    function toggleDropdownFor(button) {
        const field = button.dataset.field;
        const dropdown = panel.querySelector(`.history-dropdown[data-field="${field}"]`);
        if (!dropdown) return;
        const isHidden = dropdown.hasAttribute('hidden');
        hideAllDropdowns();
        if (isHidden) {
            fetchHistoryValues(field).then(items => {
                buildHistoryDropdown(field, dropdown, items);
                dropdown.removeAttribute('hidden');
                dropdown.scrollIntoView({ block: 'nearest' });
            }).catch(err => {
                console.error('Erro ao popular histórico', err);
                dropdown.removeAttribute('hidden');
            });
        } else {
            dropdown.setAttribute('hidden', '');
        }
    }

    // Delegation: opened only within the item panel
    function attachHistoryButtonsHandlers() {
        // scope aos botões dentro do panel (evita conflitos)
        const buttons = panel.querySelectorAll('.history-btn');
        buttons.forEach(btn => {
            // avoid duplicate listeners
            btn.removeEventListener('click', btn._historyClickHandler);
            const handler = (e) => {
                e.stopPropagation();
                toggleDropdownFor(btn);
            };
            btn._historyClickHandler = handler;
            btn.addEventListener('click', handler);
        });

        // click fora fecha (apenas quando o panel está aberto)
        document.addEventListener('click', function _outsideClick(e) {
            if (!panel || panel.style.display === 'none') return;
            const isBtn = e.target.closest && e.target.closest('.history-btn');
            const isDropdown = e.target.closest && e.target.closest('.history-dropdown');
            if (!isBtn && !isDropdown) hideAllDropdowns();
        });
    }

    async function refreshHistoryCacheForFields(fields = ['categoria', 'tipo_item', 'tipo_dano']) {
        try {
            for (const f of fields) {
                _historyCache[f] = null; // invalida
                await fetchHistoryValues(f);
            }
        } catch (e) { /* silent */ }
    }

    /* ===== fim do histórico ===== */

    function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    async function loadItens() {
        try {
            itensListEl.innerHTML = '<p>Carregando...</p>';
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, ITENS_COLLECTION);
            const snap = await fns.getDocs(colRef);
            itensListEl.innerHTML = '';

            if (!snap || snap.size === 0) {
                itensListEl.innerHTML = '<p>Nenhum item cadastrado.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
          <h4>${escapeHtml(data.nome || 'Sem nome')}</h4>
          <p><strong>Categoria:</strong> ${escapeHtml(data.categoria || data.tipo_item || '-')}</p>
          <p>${escapeHtml((data.descricao || '').slice(0, 120))}${(data.descricao && data.descricao.length > 120) ? '...' : ''}</p>
          <p><strong>Peso:</strong> ${typeof data.peso === 'number' ? data.peso : '—'}</p>
          <div class="card-actions">
            <button data-edit-id="${id}" class="edit-item-btn">Editar</button>
            <button data-delete-id="${id}" class="del-item-btn">Excluir</button>
          </div>
        `;
                itensListEl.appendChild(card);
            });

            // bind events
            itensListEl.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', () => openFormForEdit(btn.dataset.editId));
            });
            itensListEl.querySelectorAll('.del-item-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.deleteId;
                    if (!confirm('Confirma excluir este item?')) return;
                    try {
                        const fns = await resolveFirestoreFunctions();
                        const docRef = fns.doc(window.firestoredb, ITENS_COLLECTION, id);
                        if (typeof fns.deleteDoc === 'function') await fns.deleteDoc(docRef);
                        else if (typeof window.deleteDoc === 'function') await window.deleteDoc(docRef);
                        else await fns.setDoc(docRef, { _deleted: true }, { merge: true });
                        alert('Excluído.');
                        //loadItens();
                        refreshHistoryCacheForFields(); // atualizar histórico pois item removido pode afetar lista
                    } catch (err) {
                        console.error('Erro excluindo item:', err);
                        alert('Erro ao excluir (veja console).');
                    }
                });
            });

        } catch (err) {
            console.error('Erro ao carregar itens:', err);
            itensListEl.innerHTML = '<p>Erro ao carregar itens.</p>';
        }
    }

    function openFormForNew() {
        form.removeAttribute('data-doc-id');
        form.reset();
        // valores padrão
        document.getElementById('item_categoria').value = 'Utilitário';
        document.getElementById('item_tipo_item').value = 'Utilitário';
        document.getElementById('item_dano').value = 'Nenhum';
        document.getElementById('item_tipo_dano').value = 'Nenhum';
        document.getElementById('item_critico').value = 'Nenhum';
        document.getElementById('item_habilidade').value = 'Nenhum';
        document.getElementById('item_peso').value = 1;
        panel.style.display = 'block';

        // attach history handlers now that panel is visible
        attachHistoryButtonsHandlers();
    }

    async function openFormForEdit(docId) {
        try {
            const fns = await resolveFirestoreFunctions();
            const docRef = fns.doc(window.firestoredb, ITENS_COLLECTION, docId);
            const snap = await fns.getDoc(docRef);
            if (!snap.exists()) { alert('Documento não encontrado.'); return; }
            const data = snap.data();

            document.getElementById('item_nome').value = data.nome || '';
            document.getElementById('item_categoria').value = data.categoria || '';
            document.getElementById('item_tipo_item').value = data.tipo_item || '';
            document.getElementById('item_descricao').value = data.descricao || '';
            document.getElementById('item_efeito').value = data.efeito || '';
            document.getElementById('item_dano').value = data.dano || '';
            document.getElementById('item_tipo_dano').value = data.tipo_dano || '';
            document.getElementById('item_critico').value = data.critico || '';
            document.getElementById('item_habilidade').value = data.habilidade || '';
            document.getElementById('item_requisito').value = data.requisito || '';
            document.getElementById('item_peso').value = (typeof data.peso === 'number') ? data.peso : 0;

            form.setAttribute('data-doc-id', docId);
            panel.style.display = 'block';

            // attach handlers
            attachHistoryButtonsHandlers();
        } catch (err) {
            console.error('Erro ao abrir item para editar:', err);
            alert('Erro ao carregar item.');
        }
    }

    // eventos / bindings
    novoItemBtn?.addEventListener('click', openFormForNew);
    refreshItensBtn?.addEventListener('click', () => { loadItens(); refreshHistoryCacheForFields(); });
    openBtn?.addEventListener('click', openFormForNew);
    closeBtn?.addEventListener('click', () => panel.style.display = 'none');
    cancelBtn?.addEventListener('click', () => panel.style.display = 'none');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const nome = document.getElementById('item_nome').value.trim();
            const categoria = document.getElementById('item_categoria').value.trim();
            const tipo_item = document.getElementById('item_tipo_item').value.trim();
            const descricao = document.getElementById('item_descricao').value.trim();
            const efeito = document.getElementById('item_efeito').value.trim();
            const dano = document.getElementById('item_dano').value.trim();
            const tipo_dano = document.getElementById('item_tipo_dano').value.trim();
            const critico = document.getElementById('item_critico').value.trim();
            const habilidade = document.getElementById('item_habilidade').value.trim();
            const requisito = document.getElementById('item_requisito').value.trim();
            const peso = Number(document.getElementById('item_peso').value) || 0;

            if (!nome) { alert('Nome é obrigatório.'); return; }

            const payload = { nome, categoria, tipo_item, descricao, efeito, dano, tipo_dano, critico, habilidade, requisito, peso };

            const docId = form.getAttribute('data-doc-id');
            const fns = await resolveFirestoreFunctions();
            if (docId) {
                const docRef = fns.doc(window.firestoredb, ITENS_COLLECTION, docId);
                if (typeof fns.setDoc === 'function') await fns.setDoc(docRef, payload, { merge: true });
                else if (typeof fns.updateDoc === 'function') await fns.updateDoc(docRef, payload);
                else await fns.addDoc(fns.collection(window.firestoredb, ITENS_COLLECTION), payload);
                alert('Item atualizado.');
                await refreshHistoryCacheForFields(); // atualiza histórico com possíveis novos valores
            } else {
                await fns.addDoc(fns.collection(window.firestoredb, ITENS_COLLECTION), payload);
                alert('Item criado.');
                await refreshHistoryCacheForFields(); // atualiza histórico com possíveis novos valores
            }

            form.reset();
            panel.style.display = 'none';
            //loadItens();
        } catch (err) {
            console.error('Erro ao salvar item:', err);
            alert('Erro ao salvar item (veja console).');
        }
    });

    // inicial
    //loadItens();
    // também carrega cache inicial do histórico já na inicialização (opcional)
    //refreshHistoryCacheForFields();
})();

/* === FEITIÇOS: list / edit / create / delete === */
(function () {
    const FEITICOS_COLLECTION = 'feitiços'; // use exatamente o nome que você tem no Firestore

    const openBtn = document.getElementById('open-add-feitico');
    const panel = document.getElementById('add-feitico-panel');
    const closeBtn = panel?.querySelector('.close-add-feitico');
    const form = document.getElementById('add-feitico-form');

    const feiticosListEl = document.getElementById('feiticos-list');
    const novoFeiticoBtn = document.getElementById('novo-feitico-btn');
    const refreshFeiticosBtn = document.getElementById('refresh-feiticos-btn');
    const cancelBtn = document.getElementById('cancel-add-feitico');

    if (!form) return;

    /* ===== Histórico inline para campo 'elemento' (feitiços) ===== */
    const _feiticoHistoryCache = {};

    async function fetchFeiticoHistoryValues(field) {
        if (_feiticoHistoryCache[field]) return _feiticoHistoryCache[field];
        try {
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, FEITICOS_COLLECTION);
            const snap = await fns.getDocs(colRef);
            const set = new Set();
            snap.forEach(doc => {
                const val = doc.data()[field];
                if (val !== undefined && val !== null) {
                    const s = String(val).trim();
                    if (s) set.add(s);
                }
            });
            const arr = Array.from(set).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
            _feiticoHistoryCache[field] = arr;
            return arr;
        } catch (err) {
            console.error('fetchFeiticoHistoryValues error', err);
            return [];
        }
    }

    function buildFeiticoHistoryDropdown(field, targetDropdown, items) {
        targetDropdown.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'history-item';
            empty.textContent = 'Nenhum histórico';
            targetDropdown.appendChild(empty);
        } else {
            items.forEach(val => {
                const it = document.createElement('div');
                it.className = 'history-item';
                it.tabIndex = 0;
                it.textContent = val;
                it.addEventListener('click', () => {
                    const input = document.getElementById('feitico_' + field);
                    if (input) input.value = val;
                    hideAllFeiticoDropdowns();
                    input.focus();
                });
                it.addEventListener('keydown', (e) => { if (e.key === 'Enter') it.click(); });
                targetDropdown.appendChild(it);
            });
        }

        const footer = document.createElement('div');
        footer.className = 'history-footer';
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.textContent = 'Limpar';
        clearBtn.addEventListener('click', () => {
            const input = document.getElementById('feitico_' + field);
            if (input) input.value = '';
            hideAllFeiticoDropdowns();
            input.focus();
        });
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.textContent = 'Fechar';
        closeBtn.addEventListener('click', hideAllFeiticoDropdowns);
        footer.appendChild(clearBtn);
        footer.appendChild(closeBtn);
        targetDropdown.appendChild(footer);
    }

    function hideAllFeiticoDropdowns() {
        panel.querySelectorAll('.history-dropdown').forEach(d => d.setAttribute('hidden', ''));
    }

    function toggleFeiticoDropdownFor(button) {
        const field = button.dataset.field;
        const dropdown = panel.querySelector(`.history-dropdown[data-field="${field}"]`);
        if (!dropdown) return;
        const isHidden = dropdown.hasAttribute('hidden');
        hideAllFeiticoDropdowns();
        if (isHidden) {
            fetchFeiticoHistoryValues(field).then(items => {
                buildFeiticoHistoryDropdown(field, dropdown, items);
                dropdown.removeAttribute('hidden');
                dropdown.scrollIntoView({ block: 'nearest' });
            }).catch(err => {
                console.error('Erro ao popular histórico (feiticos)', err);
                dropdown.removeAttribute('hidden');
            });
        } else {
            dropdown.setAttribute('hidden', '');
        }
    }

    function attachFeiticoHistoryButtonsHandlers() {
        if (!panel) return;
        const buttons = panel.querySelectorAll('.history-btn[data-field="elemento"]');
        buttons.forEach(btn => {
            btn.removeEventListener('click', btn._historyClickHandler);
            const handler = (e) => {
                e.stopPropagation();
                toggleFeiticoDropdownFor(btn);
            };
            btn._historyClickHandler = handler;
            btn.addEventListener('click', handler);
        });

        // fechar quando clicar fora (apenas quando o painel estiver aberto)
        document.addEventListener('click', function _feitiClickClose(e) {
            if (!panel || panel.style.display === 'none') return;
            const isBtn = e.target.closest && e.target.closest('.history-btn');
            const isDropdown = e.target.closest && e.target.closest('.history-dropdown');
            if (!isBtn && !isDropdown) hideAllFeiticoDropdowns();
        });
    }

    async function refreshFeiticoHistoryCache(fields = ['elemento']) {
        try {
            for (const f of fields) {
                _feiticoHistoryCache[f] = null;
                await fetchFeiticoHistoryValues(f);
            }
        } catch (e) { /* silent */ }
    }


    function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    async function loadFeiticos() {
        try {
            feiticosListEl.innerHTML = '<p>Carregando...</p>';
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, FEITICOS_COLLECTION);
            const snap = await fns.getDocs(colRef);
            feiticosListEl.innerHTML = '';

            if (!snap || snap.size === 0) {
                feiticosListEl.innerHTML = '<p>Nenhum feitiço cadastrado.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'feitico-card';
                card.innerHTML = `
          <h4>${escapeHtml(data.nome || 'Sem nome')}</h4>
          <p><strong>Elemento:</strong> ${escapeHtml(data.elemento || '-')}</p>
          <p><strong>Custo:</strong> ${typeof data.custo === 'number' ? data.custo : '-'}</p>
          <p>${escapeHtml((data.descricao || '').slice(0, 120))}${(data.descricao && data.descricao.length > 120) ? '...' : ''}</p>
          <div class="card-actions">
            <button data-edit-id="${id}" class="edit-feitico-btn">Editar</button>
            <button data-delete-id="${id}" class="del-feitico-btn">Excluir</button>
          </div>
        `;
                feiticosListEl.appendChild(card);
            });

            // bind events
            feiticosListEl.querySelectorAll('.edit-feitico-btn').forEach(btn => {
                btn.addEventListener('click', () => openFormForEdit(btn.dataset.editId));
            });
            feiticosListEl.querySelectorAll('.del-feitico-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.deleteId;
                    if (!confirm('Confirma excluir este feitiço?')) return;
                    try {
                        const fns = await resolveFirestoreFunctions();
                        const docRef = fns.doc(window.firestoredb, FEITICOS_COLLECTION, id);
                        if (typeof fns.deleteDoc === 'function') await fns.deleteDoc(docRef);
                        else if (typeof window.deleteDoc === 'function') await window.deleteDoc(docRef);
                        else await fns.setDoc(docRef, { _deleted: true }, { merge: true });
                        alert('Excluído.');
                        //loadFeiticos();
                    } catch (err) {
                        console.error('Erro excluindo feitiço:', err);
                        alert('Erro ao excluir (veja console).');
                    }
                });
            });

        } catch (err) {
            console.error('Erro ao carregar feitiços:', err);
            feiticosListEl.innerHTML = '<p>Erro ao carregar feitiços.</p>';
        }
    }

    function openFormForNew() {
        form.removeAttribute('data-doc-id');
        form.reset();
        document.getElementById('feitico_custo').value = 3;
        document.getElementById('feitico_elemento').value = 'Básico';
        document.getElementById('feitico_img').value = '';
        document.getElementById('feitico_descricao').value = 'Projeta energia pura em linha reta. 1d6 de dano, ignora armaduras.';
        panel.style.display = 'block';
        attachFeiticoHistoryButtonsHandlers();

    }

    async function openFormForEdit(docId) {
        try {
            const fns = await resolveFirestoreFunctions();
            const docRef = fns.doc(window.firestoredb, FEITICOS_COLLECTION, docId);
            const snap = await fns.getDoc(docRef);
            if (!snap.exists()) { alert('Documento não encontrado.'); return; }
            const data = snap.data();

            document.getElementById('feitico_nome').value = data.nome || '';
            document.getElementById('feitico_custo').value = (typeof data.custo === 'number') ? data.custo : 0;
            document.getElementById('feitico_elemento').value = data.elemento || '';
            document.getElementById('feitico_img').value = data.img || '';
            document.getElementById('feitico_descricao').value = data.descricao || '';

            form.setAttribute('data-doc-id', docId);
            panel.style.display = 'block';
            attachFeiticoHistoryButtonsHandlers();

        } catch (err) {
            console.error('Erro ao abrir feitiço para editar:', err);
            alert('Erro ao carregar feitiço.');
        }
    }

    // eventos / bindings
    novoFeiticoBtn?.addEventListener('click', openFormForNew);
    refreshFeiticosBtn?.addEventListener('click', loadFeiticos);
    openBtn?.addEventListener('click', openFormForNew);
    closeBtn?.addEventListener('click', () => panel.style.display = 'none');
    cancelBtn?.addEventListener('click', () => panel.style.display = 'none');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const nome = document.getElementById('feitico_nome').value.trim();
            const custo = Number(document.getElementById('feitico_custo').value) || 0;
            const elemento = document.getElementById('feitico_elemento').value.trim();
            const img = document.getElementById('feitico_img').value.trim() || '';
            const descricao = document.getElementById('feitico_descricao').value.trim();

            if (!nome) { alert('Nome é obrigatório.'); return; }

            const payload = { nome, custo, elemento, img, descricao };

            const docId = form.getAttribute('data-doc-id');
            const fns = await resolveFirestoreFunctions();
            if (docId) {
                const docRef = fns.doc(window.firestoredb, FEITICOS_COLLECTION, docId);
                if (typeof fns.setDoc === 'function') await fns.setDoc(docRef, payload, { merge: true });
                else if (typeof fns.updateDoc === 'function') await fns.updateDoc(docRef, payload);
                else await fns.addDoc(fns.collection(window.firestoredb, FEITICOS_COLLECTION), payload);
                alert('Feitiço atualizado.');
                await refreshFeiticoHistoryCache(); // atualiza histórico com novo valor

            } else {
                await fns.addDoc(fns.collection(window.firestoredb, FEITICOS_COLLECTION), payload);
                alert('Feitiço criado.');
                await refreshFeiticoHistoryCache();
            }

            form.reset();
            panel.style.display = 'none';
            //loadFeiticos();
        } catch (err) {
            console.error('Erro ao salvar feitiço:', err);
            alert('Erro ao salvar feitiço (veja console).');
        }
    });

    // inicial
    //loadFeiticos();
})();


/* === MILAGRES: list / edit / create / delete === */
(function () {
    const MILAGRES_COLLECTION = 'milagres';

    const openBtn = document.getElementById('open-add-milagre');
    const panel = document.getElementById('add-milagre-panel');
    const closeBtn = panel?.querySelector('.close-add-milagre');
    const form = document.getElementById('add-milagre-form');

    const milagresListEl = document.getElementById('milagres-list');
    const novoMilagreBtn = document.getElementById('novo-milagre-btn');
    const refreshMilagresBtn = document.getElementById('refresh-milagres-btn');
    const cancelBtn = document.getElementById('cancel-add-milagre');

    if (!form) return;
    /* ===== Histórico inline para campos tipo / funcao / tomo (milagres) ===== */
    const _milagreHistoryCache = {};

    async function fetchMilagreHistoryValues(field) {
        if (_milagreHistoryCache[field]) return _milagreHistoryCache[field];
        try {
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, MILAGRES_COLLECTION);
            const snap = await fns.getDocs(colRef);
            const set = new Set();
            snap.forEach(doc => {
                const val = doc.data()[field];
                if (val !== undefined && val !== null) {
                    const s = String(val).trim();
                    if (s) set.add(s);
                }
            });
            const arr = Array.from(set).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
            _milagreHistoryCache[field] = arr;
            return arr;
        } catch (err) {
            console.error('fetchMilagreHistoryValues error', err);
            return [];
        }
    }

    function buildMilagreHistoryDropdown(field, targetDropdown, items) {
        targetDropdown.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'history-item';
            empty.textContent = 'Nenhum histórico';
            targetDropdown.appendChild(empty);
        } else {
            items.forEach(val => {
                const it = document.createElement('div');
                it.className = 'history-item';
                it.tabIndex = 0;
                it.textContent = val;
                it.addEventListener('click', () => {
                    const input = document.getElementById('milagre_' + field);
                    if (input) input.value = val;
                    hideAllMilagreDropdowns();
                    input.focus();
                });
                it.addEventListener('keydown', (e) => { if (e.key === 'Enter') it.click(); });
                targetDropdown.appendChild(it);
            });
        }

        const footer = document.createElement('div');
        footer.className = 'history-footer';
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.textContent = 'Limpar';
        clearBtn.addEventListener('click', () => {
            const input = document.getElementById('milagre_' + field);
            if (input) input.value = '';
            hideAllMilagreDropdowns();
            input.focus();
        });
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.textContent = 'Fechar';
        closeBtn.addEventListener('click', hideAllMilagreDropdowns);
        footer.appendChild(clearBtn);
        footer.appendChild(closeBtn);
        targetDropdown.appendChild(footer);
    }

    function hideAllMilagreDropdowns() {
        panel.querySelectorAll('.history-dropdown').forEach(d => d.setAttribute('hidden', ''));
    }

    function toggleMilagreDropdownFor(button) {
        const field = button.dataset.field;
        const dropdown = panel.querySelector(`.history-dropdown[data-field="${field}"]`);
        if (!dropdown) return;
        const isHidden = dropdown.hasAttribute('hidden');
        hideAllMilagreDropdowns();
        if (isHidden) {
            fetchMilagreHistoryValues(field).then(items => {
                buildMilagreHistoryDropdown(field, dropdown, items);
                dropdown.removeAttribute('hidden');
                dropdown.scrollIntoView({ block: 'nearest' });
            }).catch(err => {
                console.error('Erro ao popular histórico (milagres)', err);
                dropdown.removeAttribute('hidden');
            });
        } else {
            dropdown.setAttribute('hidden', '');
        }
    }

    function attachMilagreHistoryButtonsHandlers() {
        if (!panel) return;
        const buttons = panel.querySelectorAll('.history-btn');
        buttons.forEach(btn => {
            btn.removeEventListener('click', btn._historyClickHandler);
            const handler = (e) => {
                e.stopPropagation();
                toggleMilagreDropdownFor(btn);
            };
            btn._historyClickHandler = handler;
            btn.addEventListener('click', handler);
        });

        // fecha dropdown ao clicar fora (quando o painel está aberto)
        document.addEventListener('click', function _milagreOutsideClick(e) {
            if (!panel || panel.style.display === 'none') return;
            const isBtn = e.target.closest && e.target.closest('.history-btn');
            const isDropdown = e.target.closest && e.target.closest('.history-dropdown');
            if (!isBtn && !isDropdown) hideAllMilagreDropdowns();
        });
    }

    async function refreshMilagreHistoryCache(fields = ['tipo', 'funcao', 'tomo']) {
        try {
            for (const f of fields) {
                _milagreHistoryCache[f] = null; // invalida
                await fetchMilagreHistoryValues(f);
            }
        } catch (e) { /* silent */ }
    }


    function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    async function loadMilagres() {
        try {
            milagresListEl.innerHTML = '<p>Carregando...</p>';
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, MILAGRES_COLLECTION);
            const snap = await fns.getDocs(colRef);
            milagresListEl.innerHTML = '';

            if (!snap || snap.size === 0) {
                milagresListEl.innerHTML = '<p>Nenhum milagre cadastrado.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'milagre-card';
                card.innerHTML = `
          <h4>${escapeHtml(data.nome || 'Sem nome')}</h4>
          <p><strong>Tipo:</strong> ${escapeHtml(data.tipo || '-')}</p>
          <p><strong>Função:</strong> ${escapeHtml(data.funcao || '-')}</p>
          <p><strong>Custo:</strong> ${escapeHtml(String(data.custo || '-'))}</p>
          <p>${escapeHtml((data.descricao || '').slice(0, 120))}${(data.descricao && data.descricao.length > 120) ? '...' : ''}</p>
          <div class="card-actions">
            <button data-edit-id="${id}" class="edit-milagre-btn">Editar</button>
            <button data-delete-id="${id}" class="del-milagre-btn">Excluir</button>
          </div>
        `;
                milagresListEl.appendChild(card);
            });

            // bind events
            milagresListEl.querySelectorAll('.edit-milagre-btn').forEach(btn => {
                btn.addEventListener('click', () => openFormForEdit(btn.dataset.editId));
            });
            milagresListEl.querySelectorAll('.del-milagre-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.deleteId;
                    if (!confirm('Confirma excluir este milagre?')) return;
                    try {
                        const fns = await resolveFirestoreFunctions();
                        const docRef = fns.doc(window.firestoredb, MILAGRES_COLLECTION, id);
                        if (typeof fns.deleteDoc === 'function') await fns.deleteDoc(docRef);
                        else if (typeof window.deleteDoc === 'function') await window.deleteDoc(docRef);
                        else await fns.setDoc(docRef, { _deleted: true }, { merge: true });
                        alert('Excluído.');
                        //loadMilagres();
                        refreshMilagreHistoryCache(); // não precisa await aqui
                    } catch (err) {
                        console.error('Erro excluindo milagre:', err);
                        alert('Erro ao excluir (veja console).');
                    }
                });
            });

        } catch (err) {
            console.error('Erro ao carregar milagres:', err);
            milagresListEl.innerHTML = '<p>Erro ao carregar milagres.</p>';
        }
    }

    function openFormForNew() {
        form.removeAttribute('data-doc-id');
        form.reset();
        // valores padrão
        document.getElementById('milagre_custo').value = '3/15';
        document.getElementById('milagre_tipo').value = 'Divino';
        document.getElementById('milagre_funcao').value = 'Defensivo';
        document.getElementById('milagre_tomo').value = 'Solyn';
        document.getElementById('milagre_efeito').value = 'Nenhum';
        document.getElementById('milagre_descricao').value = 'Cria uma aura que regenera 4d4 PV por turno em aliados dentro de 3 m, por 2 turnos';
        panel.style.display = 'block';
        attachMilagreHistoryButtonsHandlers();

    }

    async function openFormForEdit(docId) {
        try {
            const fns = await resolveFirestoreFunctions();
            const docRef = fns.doc(window.firestoredb, MILAGRES_COLLECTION, docId);
            const snap = await fns.getDoc(docRef);
            if (!snap.exists()) { alert('Documento não encontrado.'); return; }
            const data = snap.data();

            document.getElementById('milagre_nome').value = data.nome || '';
            document.getElementById('milagre_custo').value = data.custo || '';
            document.getElementById('milagre_tipo').value = data.tipo || '';
            document.getElementById('milagre_funcao').value = data.funcao || '';
            document.getElementById('milagre_tomo').value = data.tomo || '';
            document.getElementById('milagre_efeito').value = data.efeito || '';
            document.getElementById('milagre_descricao').value = data.descricao || '';

            form.setAttribute('data-doc-id', docId);
            panel.style.display = 'block';
            attachMilagreHistoryButtonsHandlers();

        } catch (err) {
            console.error('Erro ao abrir milagre para editar:', err);
            alert('Erro ao carregar milagre.');
        }
    }

    // eventos / bindings
    novoMilagreBtn?.addEventListener('click', openFormForNew);
    refreshMilagresBtn?.addEventListener('click', loadMilagres);
    openBtn?.addEventListener('click', openFormForNew);
    closeBtn?.addEventListener('click', () => panel.style.display = 'none');
    cancelBtn?.addEventListener('click', () => panel.style.display = 'none');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const nome = document.getElementById('milagre_nome').value.trim();
            const custo = document.getElementById('milagre_custo').value.trim();
            const tipo = document.getElementById('milagre_tipo').value.trim();
            const funcao = document.getElementById('milagre_funcao').value.trim();
            const tomo = document.getElementById('milagre_tomo').value.trim();
            const efeito = document.getElementById('milagre_efeito').value.trim();
            const descricao = document.getElementById('milagre_descricao').value.trim();

            if (!nome) { alert('Nome é obrigatório.'); return; }

            const payload = { nome, custo, tipo, funcao, tomo, efeito, descricao };

            const docId = form.getAttribute('data-doc-id');
            const fns = await resolveFirestoreFunctions();
            if (docId) {
                const docRef = fns.doc(window.firestoredb, MILAGRES_COLLECTION, docId);
                if (typeof fns.setDoc === 'function') await fns.setDoc(docRef, payload, { merge: true });
                else if (typeof fns.updateDoc === 'function') await fns.updateDoc(docRef, payload);
                else await fns.addDoc(fns.collection(window.firestoredb, MILAGRES_COLLECTION), payload);
                alert('Milagre atualizado.');
                await refreshMilagreHistoryCache();
            } else {
                await fns.addDoc(fns.collection(window.firestoredb, MILAGRES_COLLECTION), payload);
                alert('Milagre criado.');
                await refreshMilagreHistoryCache();
            }

            form.reset();
            panel.style.display = 'none';
            //loadMilagres();
        } catch (err) {
            console.error('Erro ao salvar milagre:', err);
            alert('Erro ao salvar milagre (veja console).');
        }
    });

    // inicial
    //loadMilagres();
})();

/* === Global search + filtros (adicionado) === */
(function () {
    const SEARCH_COLLECTIONS = ['caminhos', 'condicoes', 'itens', 'feitiços', 'milagres', 'usuarios'];

    const input = document.getElementById('global-search-input');
    const clearBtn = document.getElementById('clear-search-btn');
    const openFiltersBtn = document.getElementById('open-search-filters');
    const filterDropdown = document.getElementById('search-filter-dropdown');
    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    const searchResultsEl = document.getElementById('search-results');

    // small debounce util
    function debounce(fn, wait = 500) {
        let t = null;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // helper: flatten doc data to array of strings
    function flattenStrings(value, out = []) {
        if (value == null) return out;
        if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
            out.push(String(value));
            return out;
        }
        if (Array.isArray(value)) {
            for (const v of value) flattenStrings(v, out);
            return out;
        }
        if (typeof value === 'object') {
            for (const k of Object.keys(value)) flattenStrings(value[k], out);
            return out;
        }
        return out;
    }

    // fetch distinct values for a collection+field
    async function getDistinctValues(collection, field) {
        try {
            const fns = await resolveFirestoreFunctions();
            const colRef = fns.collection(window.firestoredb, collection);
            const snap = await fns.getDocs(colRef);
            const s = new Set();
            snap.forEach(d => {
                const v = d.data()[field];
                if (v !== undefined && v !== null) s.add(String(v));
            });
            return Array.from(s).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
        } catch (e) {
            console.error('getDistinctValues', collection, field, e);
            return [];
        }
    }

    // populate subfilter buttons (calls once on init)
    async function populateAllSubfilters() {
        const mapping = {
            'caminhos': ['classe'],
            'condicoes': ['tipo'],
            'itens': ['categoria', 'tipo_item', 'tipo_dano'],
            'feitiços': ['elemento'],
            'milagres': ['tipo', 'tomo', 'funcao']
        };

        for (const coll of Object.keys(mapping)) {
            for (const field of mapping[coll]) {
                const container = filterDropdown.querySelector(`.filter-values[data-field="${field}"]`);
                if (!container) continue;
                container.innerHTML = '<div style="color:#cfc0bb;padding:6px 0">Carregando...</div>';
                const vals = await getDistinctValues(coll, field);
                container.innerHTML = '';
                if (!vals.length) {
                    container.innerHTML = '<div style="color:#9c8a86;padding:6px 0">Nenhum</div>';
                    continue;
                }
                for (const v of vals) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = v;
                    btn.dataset.field = field;
                    btn.dataset.value = v;
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('active');
                    });
                    container.appendChild(btn);
                }
            }
        }
    }

    // open/close filter dropdown
    openFiltersBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = filterDropdown.hasAttribute('hidden');
        if (isHidden) {
            filterDropdown.removeAttribute('hidden');
        } else {
            filterDropdown.setAttribute('hidden', '');
        }
    });
    // close when click outside
    document.addEventListener('click', (e) => {
        if (!filterDropdown) return;
        if (!filterDropdown.contains(e.target) && e.target !== openFiltersBtn) {
            filterDropdown.setAttribute('hidden', '');
        }
    });

    // show/hide nested filters when collection checkbox toggles
    filterDropdown.querySelectorAll('.filter-coll').forEach(chk => {
        chk.addEventListener('change', (e) => {
            const coll = chk.dataset.coll;
            const nested = filterDropdown.querySelector(`.nested-filters[data-coll="${coll}"]`);
            if (chk.checked) nested?.removeAttribute('hidden');
            else nested?.setAttribute('hidden', '');
        });
    });

    resetFiltersBtn?.addEventListener('click', () => {
        filterDropdown.querySelectorAll('.filter-coll').forEach(c => { c.checked = false; });
        filterDropdown.querySelectorAll('.nested-filters').forEach(n => n.setAttribute('hidden', ''));
        filterDropdown.querySelectorAll('.filter-values button.active').forEach(b => b.classList.remove('active'));
        // optional: trigger search with no filters
        doSearch();
    });

    applyFiltersBtn?.addEventListener('click', () => {
        filterDropdown.setAttribute('hidden', '');
        doSearch();
    });

    clearBtn?.addEventListener('click', () => {
        input.value = '';
        doSearch();
    });

    // build filter criteria object from UI
    function readActiveFilters() {
        const collChecks = Array.from(filterDropdown.querySelectorAll('.filter-coll'));
        const activeColls = collChecks.filter(c => c.checked).map(c => c.dataset.coll);
        // if none selected -> search all
        const collections = activeColls.length ? activeColls : SEARCH_COLLECTIONS;
        const details = {};
        // gather selected values per field
        filterDropdown.querySelectorAll('.filter-values').forEach(container => {
            const field = container.dataset.field;
            const selected = Array.from(container.querySelectorAll('button.active')).map(b => b.dataset.value);
            if (selected.length) details[field] = selected;
        });
        return { collections, details };
    }

    // main search function
    async function runSearch(term, collections, details) {
        const results = [];
        const t = String(term || '').trim().toLowerCase();

        // fast path: empty term => return empty results (or you could show recently added)
        if (!t) return results;

        const fns = await resolveFirestoreFunctions();

        for (const coll of collections) {
            try {
                const colRef = fns.collection(window.firestoredb, coll);
                const snap = await fns.getDocs(colRef);
                snap.forEach(doc => {
                    const data = doc.data();
                    // apply per-field filter if present (ex: class matching for caminhos)
                    let passesFieldFilters = true;
                    // details keys correspond to field names, apply only when field exists in doc
                    for (const fieldName of Object.keys(details || {})) {
                        const allowed = details[fieldName]; // array
                        if (!allowed || !allowed.length) continue;
                        // doc may have field (string or array)
                        const val = data[fieldName];
                        if (val === undefined || val === null) { passesFieldFilters = false; break; }
                        // if val is array, require any intersection
                        if (Array.isArray(val)) {
                            const any = val.some(v => allowed.includes(String(v)));
                            if (!any) { passesFieldFilters = false; break; }
                        } else {
                            if (!allowed.includes(String(val))) { passesFieldFilters = false; break; }
                        }
                    }
                    if (!passesFieldFilters) return;

                    // flatten fields to strings
                    const flat = flattenStrings(data).map(s => s.toLowerCase());
                    // also include id
                    flat.push(doc.id.toLowerCase());
                    // also for usuarios we want to include nested personagens.nome etc (already flattened)
                    const matched = flat.some(s => s.includes(t));
                    if (matched) {
                        results.push({ collection: coll, id: doc.id, data });
                    }
                });
            } catch (e) {
                console.error('search fail', coll, e);
            }
        }
        return results;
    }

    // render results
    function renderResults(results) {
        if (!searchResultsEl) return;
        if (!results || !results.length) {
            searchResultsEl.innerHTML = '<div style="color:#cfc0bb;padding:8px">Nenhum resultado.</div>';
            searchResultsEl.removeAttribute('hidden');
            return;
        }
        // group by collection
        const frag = document.createDocumentFragment();
        for (const r of results) {
            const row = document.createElement('div');
            row.className = 'search-result-item';
            const left = document.createElement('div');
            left.innerHTML = `<div><strong>${r.data.nome || '(Sem nome)'}</strong></div>
                        <div class="meta">${r.collection} — id: ${r.id}</div>
                        <div style="color:#d6c9c6;margin-top:6px;">${(r.data.descricao || r.data.descricao_geral || '').slice(0, 140)}</div>`;
            const right = document.createElement('div');
            right.className = 'btns';
            const previewBtn = document.createElement('button');
            previewBtn.type = 'button';
            previewBtn.textContent = 'Visualizar';
            previewBtn.addEventListener('click', () => openPreviewModal(r));
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.textContent = 'Editar';
            editBtn.addEventListener('click', () => openEditorForCollection(r.collection, r.id, r.data));
            right.appendChild(previewBtn);
            right.appendChild(editBtn);

            row.appendChild(left);
            row.appendChild(right);
            frag.appendChild(row);
        }

        searchResultsEl.innerHTML = '';
        searchResultsEl.appendChild(frag);
        searchResultsEl.removeAttribute('hidden');
        // scroll to results
        searchResultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Generic preview modal (simple): reuse alert for simplicity (or implement a small modal)
    function openPreviewModal(result) {
        const txt = JSON.stringify({ id: result.id, collection: result.collection, data: result.data }, null, 2);
        // show in a window.open-like pre
        const w = window.open('', '_blank', 'width=700,height=600');
        w.document.write(`<pre style="white-space:pre-wrap;font-family:monospace;padding:12px;background:#0d0d0d;color:#efe6e2;">${escapeHtml(txt)}</pre>`);
    }

    // try to open the proper editor panel and populate the form (best-effort)
    async function openEditorForCollection(collection, id, data) {
        // map collection -> panel ids & field mapping (best-effort)
        if (collection === 'itens') {
            // open item panel
            const form = document.getElementById('add-item-form');
            if (!form) return alert('Painel de itens não encontrado.');
            document.getElementById('item_nome').value = data.nome || '';
            document.getElementById('item_categoria').value = data.categoria || '';
            document.getElementById('item_tipo_item').value = data.tipo_item || '';
            document.getElementById('item_descricao').value = data.descricao || '';
            document.getElementById('item_efeito').value = data.efeito || '';
            document.getElementById('item_dano').value = data.dano || '';
            document.getElementById('item_tipo_dano').value = data.tipo_dano || '';
            document.getElementById('item_critico').value = data.critico || '';
            document.getElementById('item_habilidade').value = data.habilidade || '';
            document.getElementById('item_requisito').value = data.requisito || '';
            document.getElementById('item_peso').value = (typeof data.peso === 'number') ? data.peso : 0;
            form.setAttribute('data-doc-id', id);
            document.getElementById('add-item-panel').style.display = 'block';
            // attach history handlers if exist
            if (typeof attachHistoryButtonsHandlers === 'function') attachHistoryButtonsHandlers();
            return;
        }

        if (collection === 'caminhos') {
            const form = document.getElementById('add-caminho-form');
            if (!form) return alert('Painel de caminhos não encontrado.');
            document.getElementById('c_classe').value = data.classe || '';
            document.getElementById('c_nome').value = data.nome || '';
            document.getElementById('c_descricao_geral').value = data.descricao_geral || '';
            document.getElementById('c_img').value = data.img || '';
            // niveis: replace DOM niveis
            const nc = document.getElementById('niveis-container');
            if (nc) {
                nc.innerHTML = '';
                const arr = Array.isArray(data.niveis) ? data.niveis : [];
                for (let i = 0; i < Math.max(1, arr.length); i++) {
                    const it = document.createElement('div');
                    it.className = 'nivel-item';
                    const nome = (arr[i] && arr[i].nome) ? arr[i].nome : '';
                    const desc = (arr[i] && (arr[i].descricao_nivel || arr[i].descricao)) ? (arr[i].descricao_nivel || arr[i].descricao) : '';
                    it.innerHTML = `<div class="nivel-row"><div style="flex:1;"><label>Nome do Nível<input type="text" class="nivel-nome" value="${escapeHtml(nome)}" required /></label></div><button type="button" class="remove-nivel">✕</button></div><label>Descrição do Nível<textarea class="nivel-desc" rows="3" required>${escapeHtml(desc)}</textarea></label>`;
                    nc.appendChild(it);
                    it.querySelector('.remove-nivel')?.addEventListener('click', () => it.remove());
                }
            }
            form.setAttribute('data-doc-id', id);
            document.getElementById('add-caminho-panel').style.display = 'block';
            return;
        }

        if (collection === 'condicoes') {
            const form = document.getElementById('add-condicao-form');
            if (!form) return alert('Painel de condições não encontrado.');
            document.getElementById('cond_nome').value = data.nome || '';
            document.getElementById('cond_tipo').value = data.tipo || '';
            if (document.getElementById('cond_cor')) document.getElementById('cond_cor').value = data.cor || '#696565';
            if (document.getElementById('cond_cor_hex')) document.getElementById('cond_cor_hex').value = data.cor || '#696565';
            document.getElementById('cond_duracao').value = data.duracao || '';
            document.getElementById('cond_efeito').value = data.efeito || '';
            document.getElementById('cond_descricao').value = data.descricao || '';
            form.setAttribute('data-doc-id', id);
            document.getElementById('add-condicao-panel').style.display = 'block';
            return;
        }

        if (collection === 'feitiços' || collection === 'feiticos' || collection === 'feitico') {
            const form = document.getElementById('add-feitico-form');
            if (!form) return alert('Painel de feitiços não encontrado.');
            document.getElementById('feitico_nome').value = data.nome || '';
            document.getElementById('feitico_custo').value = data.custo || '';
            document.getElementById('feitico_elemento').value = data.elemento || '';
            document.getElementById('feitico_img').value = data.img || '';
            document.getElementById('feitico_descricao').value = data.descricao || '';
            form.setAttribute('data-doc-id', id);
            document.getElementById('add-feitico-panel').style.display = 'block';
            // attach handlers if exist
            if (typeof attachFeiticoHistoryButtonsHandlers === 'function') attachFeiticoHistoryButtonsHandlers();
            return;
        }

        if (collection === 'milagres') {
            const form = document.getElementById('add-milagre-form');
            if (!form) return alert('Painel de milagres não encontrado.');
            document.getElementById('milagre_nome').value = data.nome || '';
            document.getElementById('milagre_custo').value = data.custo || '';
            document.getElementById('milagre_tipo').value = data.tipo || '';
            document.getElementById('milagre_funcao').value = data.funcao || '';
            document.getElementById('milagre_tomo').value = data.tomo || '';
            document.getElementById('milagre_efeito').value = data.efeito || '';
            document.getElementById('milagre_descricao').value = data.descricao || '';
            form.setAttribute('data-doc-id', id);
            document.getElementById('add-milagre-panel').style.display = 'block';
            if (typeof attachMilagreHistoryButtonsHandlers === 'function') attachMilagreHistoryButtonsHandlers();
            return;
        }

        if (collection === 'usuarios') {
            // abrir lista de usuarios e selecionar o adequado (best-effort)
            try {
                // find user item by uid and simulate click
                const users = document.querySelectorAll('.user-item');
                for (const u of users) {
                    if (u.innerHTML.includes(id) || u.querySelector && u.querySelector('p') && u.querySelector('p').textContent.includes(id)) {
                        u.click();
                        return;
                    }
                }
            } catch (e) { /* silent */ }
            alert('Usuário/documento localizado — abra manualmente (função limitada).');
            return;
        }

        alert('Editor automático não implementado para coleção: ' + collection);
    }

    // escape html for preview
    function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    // top-level search runner
    const doSearch = debounce(async function () {
        const term = input.value || '';
        const { collections, details } = readActiveFilters();
        if (!term.trim()) {
            // hide results
            if (searchResultsEl) searchResultsEl.setAttribute('hidden', '');
            return;
        }
        searchResultsEl.innerHTML = '<div style="padding:8px;color:#cfc0bb">Pesquisando...</div>';
        searchResultsEl.removeAttribute('hidden');
        const results = await runSearch(term, collections, details);
        renderResults(results);
    }, 450);

    // wire input
    input?.addEventListener('input', doSearch);
    input?.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

    // initialization
    (async function init() {
        // populate all subfilters once (they will fill the tiny pill lists)
        await populateAllSubfilters();
    })();

})();

/* === controle de Elementos: abre apenas 1 painel por vez (substitua por este bloco) === */
(function () {
    // botões que disparam a abertura (devem ter data-target="caminhos" / "condicoes" / "itens" / "feiticos" / "milagres")
    const toggles = document.querySelectorAll('.elemento-toggle');
    const panelsContainer = document.getElementById('elementos-panels'); // ajuste se você usa outro id

    if (!panelsContainer || !toggles.length) return;

    // fecha todos os painéis visíveis
    function closeAllPanels() {
        // use children + filter (selector '> div.open' é inválido em querySelectorAll)
        const openPanels = Array.from(panelsContainer.children).filter(ch => ch && ch.classList && ch.classList.contains('open'));
        openPanels.forEach(p => {
            p.classList.remove('open');
            p.setAttribute('hidden', '');
            // se você usa display em vez de hidden:
            // p.style.display = 'none';
        });
        toggles.forEach(t => t.classList.remove('active'));
    }

    async function openPanel(target) {
        // target: 'caminhos' | 'condicoes' | 'itens' | 'feiticos' | 'milagres' (dependendo do seu data-target)
        const pid = `${target}-list`; // corresponde aos ids que você já tem (ex: id="caminhos-list")
        const panel = document.getElementById(pid);
        if (!panel) return;

        // fecha todas e abre a solicitada
        closeAllPanels();
        panel.classList.add('open');
        panel.removeAttribute('hidden');
        // panel.style.display = ''; // se você usa style.display

        // marca o toggle correspondente
        const t = Array.from(toggles).find(x => x.dataset && x.dataset.target === target);
        if (t) t.classList.add('active');

        // se existir, chama o loader correspondente (não quebra se a função não existir)
        try {
            if (target === 'caminhos' && typeof window.loadCaminhos === 'function') await window.loadCaminhos();
            if (target === 'condicoes' && typeof window.loadCondicoes === 'function') await window.loadCondicoes();
            if (target === 'itens' && typeof window.loadItens === 'function') await window.loadItens();
            if (target === 'feiticos' && typeof window.loadFeiticos === 'function') await window.loadFeiticos();
            if (target === 'milagres' && typeof window.loadMilagres === 'function') await window.loadMilagres();
        } catch (err) {
            console.warn('Erro ao carregar dados do painel', target, err);
        }
    }

    function togglePanel(target) {
        const pid = `${target}-list`;
        const panel = document.getElementById(pid);
        if (!panel) return;
        if (panel.classList.contains('open')) {
            closeAllPanels();
        } else {
            openPanel(target);
        }
    }

    // liga os botões toggles
    toggles.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const target = btn.dataset.target;
            if (!target) return;
            togglePanel(target);
        });
    });

    // liga os botões de refresh (se existirem no DOM)
    document.getElementById('refresh-caminhos-btn')?.addEventListener('click', () => { if (typeof window.loadCaminhos === 'function') window.loadCaminhos(); });
    document.getElementById('refresh-condicoes-btn')?.addEventListener('click', () => { if (typeof window.loadCondicoes === 'function') window.loadCondicoes(); });
    document.getElementById('refresh-itens-btn')?.addEventListener('click', () => { if (typeof window.loadItens === 'function') window.loadItens(); });
    document.getElementById('refresh-feiticos-btn')?.addEventListener('click', () => { if (typeof window.loadFeiticos === 'function') window.loadFeiticos(); });
    document.getElementById('refresh-milagres-btn')?.addEventListener('click', () => { if (typeof window.loadMilagres === 'function') window.loadMilagres(); });

    // Opcional: abre automaticamente 'caminhos' ao carregar a página (descomente se desejar)
    // openPanel('caminhos');
})();
