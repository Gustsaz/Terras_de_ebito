document.addEventListener("DOMContentLoaded", () => {
    // Google login functionality - removed since in sidebar

    // garantir estado inicial mobile para evitar flash de 4 cards
    const slotsContainer = document.querySelector('.slots');
    if (window.innerWidth <= 768 && slotsContainer) {
        slotsContainer.classList.add('mobile-init');
    }

    // Update sidebar function
    const updateSidebar = (user) => {
        const sidebar = document.querySelector('.sidebar');

        // Monta HTML base (toggle + container flutuante + home)
        sidebar.innerHTML = `
        <button class="sidebar-toggle" aria-label="menu"><i class="fas fa-bars"></i></button>
        <div class="sidebar-floating"></div>
        <a href="index.html" class="sidebar-home">
            <i class="fas fa-home"></i>
        </a>
    `;

        // Desktop: adiciona perfil/admin ou botão google
        if (user && user.photoURL) {
            sidebar.innerHTML += `
            <button id="admin-login" class="sidebar-admin">
                <i class="fas fa-user-shield"></i>
            </button>
            <img src="${user.photoURL}" class="sidebar-profile" alt="Profile" />
        `;
        } else {
            sidebar.innerHTML += `
            <button id="google-login" class="sidebar-google">
                <i class="fab fa-google"></i>
            </button>
        `;
        }

        // Preencher floating menu (mobile) com classes próprias para não conflitar
        const floating = sidebar.querySelector('.sidebar-floating');
        floating.innerHTML = '';
        floating.innerHTML += `<a href="index.html" class="floating-home"><i class="fas fa-home"></i></a>`;
        if (user && user.photoURL) {
            floating.innerHTML += `<button class="floating-admin"><i class="fas fa-user-shield"></i></button>`;
            floating.innerHTML += `<img src="${user.photoURL}" class="floating-profile" alt="Profile" />`;
        } else {
            floating.innerHTML += `<button class="floating-google"><i class="fab fa-google"></i></button>`;
        }

        /* ---------- BIND EVENTS ---------- */

        // Toggle (menu mobile)
        const sidebarToggle = sidebar.querySelector('.sidebar-toggle');
        const floatingMenu = sidebar.querySelector('.sidebar-floating');
        if (sidebarToggle) {
            sidebarToggle.onclick = () => floatingMenu.classList.toggle('active');
        }

        // Google login — desktop
        const desktopGoogle = sidebar.querySelector('#google-login');
        if (desktopGoogle) {
            desktopGoogle.onclick = async () => {
                const provider = new window.GoogleAuthProvider();
                try {
                    await window.signInWithPopup(window.firebaseauth, provider);
                } catch (error) {
                    console.error('Error during sign in:', error);
                }
            };
        }

        // Google login — floating (mobile)
        const floatGoogle = floating.querySelector('.floating-google');
        if (floatGoogle) {
            floatGoogle.onclick = async () => {
                const provider = new window.GoogleAuthProvider();
                try {
                    await window.signInWithPopup(window.firebaseauth, provider);
                } catch (error) {
                    console.error('Error during sign in:', error);
                }
            };
        }

        // Admin login — desktop e floating
        const adminDesktop = sidebar.querySelector('#admin-login');
        const adminFloating = floating.querySelector('.floating-admin');
        [adminDesktop, adminFloating].forEach(btn => {
            if (btn) {
                btn.onclick = () => {
                    const adminModal = document.getElementById('admin-modal');
                    const adminPassword = document.getElementById('admin-password');
                    adminPassword.value = '';
                    adminModal.style.display = 'flex';
                    // fechar floating ao abrir (opcional)
                    if (floatingMenu) floatingMenu.classList.remove('active');
                };
            }
        });

        // Profile image — desktop e floating (mostra botão sair)
        const profileDesktop = sidebar.querySelector('.sidebar-profile');
        const profileFloating = floating.querySelector('.floating-profile');
        const profileImg = profileDesktop || profileFloating;
        if (profileImg) {
            profileImg.onclick = (e) => {
                e.stopPropagation();
                const existing = document.querySelector('.sidebar-sair');
                if (existing) { existing.remove(); return; }

                const sairBtn = document.createElement('button');
                sairBtn.className = 'sidebar-sair';
                sairBtn.textContent = 'Sair';
                sairBtn.onclick = async () => {
                    try {
                        await window.firebaseauth.signOut();
                        sairBtn.remove();
                    } catch (error) {
                        console.error('Error signing out:', error);
                    }
                };

                // remove ao clicar fora
                const onDocClick = (evt) => {
                    if (!sairBtn.contains(evt.target) && evt.target !== profileImg) {
                        sairBtn.remove();
                        document.removeEventListener('click', onDocClick);
                    }
                };
                document.addEventListener('click', onDocClick);

                sidebar.appendChild(sairBtn);
                // fechar floating ao abrir (mobile)
                if (floatingMenu) floatingMenu.classList.remove('active');
            };
        }
    };



    // Function to load characters from Firebase DB or localStorage
    const loadUserCharacters = async (user) => {
        if (!user) {
            showEmptySlots();
            updateVisibleSlot();
            return;
        }
        try {
            const userDocRef = window.doc(window.firestoredb, 'usuarios', user.uid);
            const userDocSnap = await window.getDoc(userDocRef);
            let characters = [];
            if (userDocSnap.exists()) {
                const data = userDocSnap.data();
                characters = data.personagens || [];
                // Update with name and email from auth if missing
                if (!data.name || !data.email) {
                    await window.setDoc(userDocRef, { name: user.displayName, email: user.email }, { merge: true });
                }
            } else {
                // Create initial doc with name and email from auth
                await window.setDoc(userDocRef, { name: user.displayName, email: user.email, personagens: [] });
            }
            displayCharacters(characters);
        } catch (error) {
            console.warn('Failed to load from Firebase, using localStorage', error);
            const localChars = JSON.parse(localStorage.getItem('characters')) || [];
            displayCharacters(localChars);
        }
    };

    // Function to display characters in slots
    const displayCharacters = (characters) => {
        const slots = document.querySelectorAll('.slot');
        slots.forEach((slot, index) => {
            // Clear any existing innerHTML and events
            slot.innerHTML = '';
            slot.onclick = null;
            slot.className = 'slot';
            if (characters[index]) {
                slot.classList.add('filled');
                const charImg = (characters[index].img && Array.isArray(characters[index].img) && characters[index].img.length > 0)
                    ? characters[index].img[0]
                    : `./imgs/${characters[index].classe.toLowerCase()}.png`;
                slot.innerHTML = `
                    <button class="delete-btn" data-char-id="${characters[index].uid}"><i class="fas fa-trash"></i></button>
                    <button class="edit-btn" data-char-id="${characters[index].uid}"><i class="fa-solid fa-pen"></i></button>
                    <div class="img-area">
                        <img src="${charImg}" alt="Character ${characters[index].nome}">
                    </div>
                    <div class="char-info">
                        <div class="char-name">${characters[index].nome}</div>
                        <div class="char-class">Classe: ${characters[index].classe}</div>
                    </div>
                `;

                // Delete button event
                const deleteBtn = slot.querySelector('.delete-btn');
                const charId = characters[index].uid;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent slot click
                    const deleteModal = document.getElementById('delete-modal');
                    deleteModal.style.display = 'flex';
                    deleteModal.dataset.charId = charId;
                });

                // Slot click to go to personagem
                slot.addEventListener('click', () => {
                    localStorage.setItem('selectedCharId', charId);
                    window.location.href = 'personagem.html?uid=' + encodeURIComponent(charId);
                });

                // Edit button click (prevent slot click if edit clicked)
                slot.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent slot click
                    const charId = e.target.closest('.edit-btn').dataset.charId;
                    // Store character ID for personagem page
                    localStorage.setItem('selectedCharId', charId);
                    window.location.href = 'personagem.html?uid=' + encodeURIComponent(charId);
                });
            } else {
                slot.classList.add('empty');
                slot.innerHTML = '<i class="fas fa-plus"></i>';
                slot.onclick = () => {
                    console.log('Empty slot clicked');
                    window.location.href = 'criacao_personagem.html';
                };
            }
        });
        updateVisibleSlot();

    };

    // Function to show empty slots
    const showEmptySlots = () => {
        const slots = document.querySelectorAll('.slot');
        slots.forEach(slot => {
            slot.className = 'slot empty';
            slot.innerHTML = '<i class="fas fa-plus"></i>';
            slot.onclick = () => {
                alert('Você precisa estar logado para criar um personagem.');
            };
        });
    };

    // Start with empty slots
    showEmptySlots();

    // Auth observer to load characters
    window.onAuthStateChanged(window.firebaseauth, (user) => {
        updateSidebar(user);
        loadUserCharacters(user);
        if (user) {
            localStorage.setItem('userLoggedIn', 'true');
        } else {
            localStorage.removeItem('userLoggedIn');
        }
    });

    // Delete modal events
    const deleteModal = document.getElementById('delete-modal');
    const cancelDelete = document.getElementById('cancel-delete');
    const confirmDelete = document.getElementById('confirm-delete');

    cancelDelete.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteModal.style.display = 'none';
    });

    confirmDelete.addEventListener('click', async (e) => {
        e.stopPropagation();
        const charId = deleteModal.dataset.charId;
        if (charId && window.firebaseauth.currentUser) {
            try {
                const userDocRef = window.doc(window.firestoredb, 'usuarios', window.firebaseauth.currentUser.uid);
                const userDocSnap = await window.getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    let characters = userDocSnap.data().personagens || [];
                    characters = characters.filter(c => c.uid !== charId);
                    await window.setDoc(userDocRef, { personagens: characters }, { merge: true });
                    // Reload characters
                    loadUserCharacters(window.firebaseauth.currentUser);
                }
            } catch (error) {
                console.warn('Failed to delete character', error);
            }
        }
        deleteModal.style.display = 'none';
    });

    // Admin modal events
    const adminModal = document.getElementById('admin-modal');
    const adminConfirm = document.getElementById('admin-confirm');
    const adminCancel = document.getElementById('admin-cancel');
    const adminPassword = document.getElementById('admin-password');

    adminCancel.addEventListener('click', () => {
        adminModal.style.display = 'none';
    });

    adminConfirm.addEventListener('click', () => {
        const password = adminPassword.value;
        if (password === 'ebitoMarkao234@') {
            window.location.href = 'adm.html';
        } else {
            alert('Senha incorreta.');
        }
    });
    let currentIndex = 0;

    function updateVisibleSlot() {
        if (window.innerWidth > 768) {
            // Desktop → mostrar todos
            document.querySelectorAll('.slot').forEach(s => s.style.display = "flex");
            return;
        }

        // Mobile → apenas 1 slot
        document.querySelectorAll('.slot').forEach((s, i) => {
            s.style.display = i === currentIndex ? "flex" : "none";
        });
        // depois que o JS configurou os displays, podemos remover a marca inicial
        const sc = document.querySelector('.slots');
        if (sc && sc.classList.contains('mobile-init')) {
            sc.classList.remove('mobile-init');
        }

    }

    // arrow handlers (seguro: só adiciona se existir)
    const rightArrow = document.querySelector('.right-arrow');
    const leftArrow = document.querySelector('.left-arrow');

    if (rightArrow) {
        rightArrow.addEventListener('click', () => {
            const slots = document.querySelectorAll('.slot');
            if (currentIndex < slots.length - 1) currentIndex++;
            updateVisibleSlot();
        });
    }

    if (leftArrow) {
        leftArrow.addEventListener('click', () => {
            if (currentIndex > 0) currentIndex--;
            updateVisibleSlot();
        });
    }

    // atualizar ao redimensionar (desktop <-> mobile)
    window.addEventListener('resize', updateVisibleSlot);


});
